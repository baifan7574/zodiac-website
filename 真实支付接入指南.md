# 💳 真实支付接入指南

## 概述

本文档说明如何将当前模拟支付系统接入真实的微信支付和支付宝支付接口。

**重要提示**：真实支付接入需要后端服务器支持，当前项目为纯前端H5应用，需要先搭建后端服务。

---

## 1. 前置条件

### 1.1 后端服务要求
- ✅ Node.js/Express 或 Python/Django 后端服务
- ✅ 数据库（MySQL/PostgreSQL）
- ✅ HTTPS域名（支付接口要求）
- ✅ 服务器部署

### 1.2 支付平台账号
- ✅ 微信支付商户号
- ✅ 支付宝商户号
- ✅ 支付平台API密钥

---

## 2. 微信支付接入

### 2.1 微信支付配置

#### 申请微信支付
1. 访问 [微信支付商户平台](https://pay.weixin.qq.com/)
2. 注册商户号
3. 完成企业认证
4. 获取以下信息：
   - 商户号（mch_id）
   - API密钥（key）
   - 应用ID（appid）
   - 证书文件（用于退款等高级功能）

#### 配置支付参数
```javascript
// 后端配置（示例：Node.js）
const wechatPayConfig = {
    appid: 'your_appid',
    mch_id: 'your_mch_id',
    key: 'your_api_key',
    notify_url: 'https://yourdomain.com/api/wechat/notify',
    trade_type: 'JSAPI' // 或 'H5'、'APP'、'NATIVE'
};
```

---

### 2.2 后端接口实现

#### 创建支付订单接口
```javascript
// Node.js + Express 示例
const express = require('express');
const router = express.Router();
const crypto = require('crypto');
const axios = require('axios');

// 创建支付订单
router.post('/api/payment/create', async (req, res) => {
    const { userId, planId, amount, paymentMethod } = req.body;
    
    // 1. 创建订单记录到数据库
    const order = await createOrder({
        userId,
        planId,
        amount,
        paymentMethod,
        status: 'pending'
    });
    
    // 2. 调用微信支付统一下单接口
    if (paymentMethod === 'wechat') {
        const paymentData = await createWechatPayment({
            orderId: order.id,
            amount: amount * 100, // 转换为分
            openid: req.user.openid, // 从用户信息获取
            description: `会员套餐-${planId}`
        });
        
        res.json({
            success: true,
            orderId: order.id,
            paymentData: paymentData
        });
    }
});

// 微信支付统一下单
async function createWechatPayment({ orderId, amount, openid, description }) {
    const params = {
        appid: wechatPayConfig.appid,
        mch_id: wechatPayConfig.mch_id,
        nonce_str: generateNonceStr(),
        body: description,
        out_trade_no: orderId,
        total_fee: amount,
        spbill_create_ip: '127.0.0.1',
        notify_url: wechatPayConfig.notify_url,
        trade_type: 'JSAPI',
        openid: openid
    };
    
    // 生成签名
    params.sign = generateSign(params, wechatPayConfig.key);
    
    // 调用微信支付接口
    const response = await axios.post(
        'https://api.mch.weixin.qq.com/pay/unifiedorder',
        convertToXml(params),
        { headers: { 'Content-Type': 'application/xml' } }
    );
    
    const result = parseXml(response.data);
    
    // 返回前端需要的支付参数
    return {
        timeStamp: Math.floor(Date.now() / 1000).toString(),
        nonceStr: result.nonce_str,
        package: `prepay_id=${result.prepay_id}`,
        signType: 'RSA',
        paySign: generatePaySign({
            appId: wechatPayConfig.appid,
            timeStamp: Math.floor(Date.now() / 1000).toString(),
            nonceStr: result.nonce_str,
            package: `prepay_id=${result.prepay_id}`
        })
    };
}
```

#### 支付回调接口
```javascript
// 微信支付回调
router.post('/api/wechat/notify', (req, res) => {
    const xmlData = req.body;
    const result = parseXml(xmlData);
    
    // 验证签名
    if (!verifySign(result, wechatPayConfig.key)) {
        return res.send('<xml><return_code><![CDATA[FAIL]]></return_code></xml>');
    }
    
    // 处理支付成功
    if (result.return_code === 'SUCCESS' && result.result_code === 'SUCCESS') {
        updateOrderStatus(result.out_trade_no, 'paid');
        setUserMembership(result.out_trade_no);
    }
    
    res.send('<xml><return_code><![CDATA[SUCCESS]]></return_code></xml>');
});
```

---

### 2.3 前端调用代码

#### 修改支付函数
```javascript
// js/main.js 中的支付函数修改

// 真实支付处理
async function processRealPayment(orderId, paymentMethod, paymentData) {
    if (paymentMethod === 'wechat') {
        // 调用微信支付JSAPI
        if (typeof WeixinJSBridge !== 'undefined') {
            WeixinJSBridge.invoke(
                'getBrandWCPayRequest',
                {
                    appId: paymentData.appId,
                    timeStamp: paymentData.timeStamp,
                    nonceStr: paymentData.nonceStr,
                    package: paymentData.package,
                    signType: paymentData.signType,
                    paySign: paymentData.paySign
                },
                function(res) {
                    if (res.err_msg === "get_brand_wcpay_request:ok") {
                        // 支付成功
                        handlePaymentSuccess(orderId);
                    } else {
                        // 支付失败
                        showMessage('支付失败，请重试');
                    }
                }
            );
        } else {
            // 非微信环境，使用H5支付
            window.location.href = paymentData.mweb_url;
        }
    } else if (paymentMethod === 'alipay') {
        // 支付宝支付
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = paymentData.payUrl;
        form.innerHTML = paymentData.formData;
        document.body.appendChild(form);
        form.submit();
    }
}

// 修改原有的processPayment函数
window.processPayment = async function(planId) {
    if (!checkLoginStatus()) {
        showMessage('请先登录');
        showPage('login');
        return;
    }
    
    const plan = membershipPlans[planId];
    if (!plan) return;
    
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
    if (!paymentMethod) {
        showMessage('请选择支付方式');
        return;
    }
    
    try {
        // 调用后端创建订单接口
        const response = await fetch('/api/payment/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify({
                userId: currentUser.phone,
                planId: planId,
                amount: plan.price,
                paymentMethod: paymentMethod
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 调用真实支付
            await processRealPayment(result.orderId, paymentMethod, result.paymentData);
        } else {
            showMessage(result.message || '创建订单失败');
        }
    } catch (error) {
        console.error('支付错误:', error);
        showMessage('支付失败，请稍后重试');
    }
};
```

---

## 3. 支付宝支付接入

### 3.1 支付宝配置

#### 申请支付宝商户
1. 访问 [支付宝开放平台](https://open.alipay.com/)
2. 注册企业账号
3. 创建应用
4. 获取以下信息：
   - 应用ID（app_id）
   - 应用私钥（private_key）
   - 支付宝公钥（alipay_public_key）

---

### 3.2 后端接口实现

#### 创建支付宝支付订单
```javascript
// Node.js + Express 示例
const AlipaySdk = require('alipay-sdk').default;
const AlipayFormData = require('alipay-sdk/lib/form').default;

const alipaySdk = new AlipaySdk({
    appId: 'your_app_id',
    privateKey: 'your_private_key',
    alipayPublicKey: 'your_alipay_public_key',
    gateway: 'https://openapi.alipay.com/gateway.do'
});

// 创建支付宝支付
router.post('/api/payment/create', async (req, res) => {
    const { userId, planId, amount, paymentMethod } = req.body;
    
    // 创建订单
    const order = await createOrder({
        userId,
        planId,
        amount,
        paymentMethod,
        status: 'pending'
    });
    
    if (paymentMethod === 'alipay') {
        const formData = new AlipayFormData();
        formData.setMethod('get');
        
        formData.addField('bizContent', {
            outTradeNo: order.id,
            productCode: 'QUICK_MSECURITY_PAY',
            totalAmount: amount.toString(),
            subject: `会员套餐-${planId}`,
            body: `购买${planId}会员套餐`
        });
        
        formData.setMethod('get');
        
        const result = await alipaySdk.exec(
            'alipay.trade.app.pay',
            {},
            { formData: formData }
        );
        
        res.json({
            success: true,
            orderId: order.id,
            paymentData: {
                payUrl: result,
                formData: formData.toString()
            }
        });
    }
});

// 支付宝回调
router.post('/api/alipay/notify', (req, res) => {
    const params = req.body;
    
    // 验证签名
    const verified = alipaySdk.checkNotifySign(params);
    
    if (verified && params.trade_status === 'TRADE_SUCCESS') {
        updateOrderStatus(params.out_trade_no, 'paid');
        setUserMembership(params.out_trade_no);
        res.send('success');
    } else {
        res.send('fail');
    }
});
```

---

### 3.3 前端调用代码

#### 支付宝支付调用
```javascript
// 支付宝支付处理
async function processAlipayPayment(orderId, paymentData) {
    // 方式1：跳转到支付宝支付页面
    if (paymentData.payUrl) {
        window.location.href = paymentData.payUrl;
    }
    
    // 方式2：使用表单提交
    if (paymentData.formData) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = 'https://openapi.alipay.com/gateway.do';
        form.innerHTML = paymentData.formData;
        document.body.appendChild(form);
        form.submit();
    }
}
```

---

## 4. 支付流程优化

### 4.1 支付状态查询

```javascript
// 轮询查询支付状态
async function checkPaymentStatus(orderId) {
    const maxAttempts = 30; // 最多查询30次
    let attempts = 0;
    
    const interval = setInterval(async () => {
        attempts++;
        
        try {
            const response = await fetch(`/api/payment/status/${orderId}`, {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });
            
            const result = await response.json();
            
            if (result.status === 'paid') {
                clearInterval(interval);
                handlePaymentSuccess(orderId);
            } else if (result.status === 'failed') {
                clearInterval(interval);
                showMessage('支付失败');
            } else if (attempts >= maxAttempts) {
                clearInterval(interval);
                showMessage('支付超时，请检查支付状态');
            }
        } catch (error) {
            console.error('查询支付状态错误:', error);
        }
    }, 2000); // 每2秒查询一次
}
```

---

## 5. 安全注意事项

### 5.1 前端安全
- ✅ 不在前端存储支付密钥
- ✅ 所有支付请求通过后端
- ✅ 验证支付回调签名
- ✅ 使用HTTPS传输

### 5.2 后端安全
- ✅ 验证订单金额
- ✅ 验证用户身份
- ✅ 防止重复支付
- ✅ 记录支付日志

---

## 6. 测试环境

### 6.1 微信支付测试
- 使用微信支付沙箱环境
- 测试账号和密钥
- 测试回调地址

### 6.2 支付宝测试
- 使用支付宝沙箱环境
- 测试账号和密钥
- 测试回调地址

---

## 7. 部署清单

### 7.1 生产环境配置
- [ ] 配置HTTPS证书
- [ ] 配置支付回调地址
- [ ] 配置支付密钥
- [ ] 配置数据库连接
- [ ] 配置日志记录

### 7.2 监控和告警
- [ ] 支付成功率监控
- [ ] 支付失败告警
- [ ] 订单异常监控

---

## 8. 代码集成步骤

### 步骤1：搭建后端服务
1. 创建Node.js/Express项目
2. 配置数据库
3. 实现用户认证

### 步骤2：集成支付SDK
1. 安装微信支付SDK
2. 安装支付宝SDK
3. 配置支付参数

### 步骤3：实现支付接口
1. 创建订单接口
2. 支付回调接口
3. 支付状态查询接口

### 步骤4：修改前端代码
1. 修改`processPayment`函数
2. 添加支付状态查询
3. 处理支付回调

### 步骤5：测试
1. 沙箱环境测试
2. 生产环境测试
3. 支付流程测试

---

## 9. 常见问题

### Q1: 支付回调没有收到？
- 检查回调地址是否正确
- 检查服务器是否可访问
- 检查防火墙设置

### Q2: 支付签名错误？
- 检查密钥配置
- 检查签名算法
- 检查参数顺序

### Q3: 支付成功后订单未更新？
- 检查回调处理逻辑
- 检查数据库连接
- 检查事务处理

---

## 10. 参考文档

- [微信支付开发文档](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [支付宝开放平台](https://open.alipay.com/)
- [微信支付JSAPI](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml)
- [支付宝手机网站支付](https://opendocs.alipay.com/open/203/105285)

---

**更新时间**：2024年12月  
**状态**：接入指南完成，需要后端支持

